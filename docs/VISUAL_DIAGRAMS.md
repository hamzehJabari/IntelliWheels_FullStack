# IntelliWheels - Visual Diagrams & Flowcharts

This document contains detailed visual diagrams for the IntelliWheels platform.

---

## 1. Complete System Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              INTELLIWHEELS COMPLETE SYSTEM FLOW                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                         ┌───────────────┐
                                         │    USER       │
                                         │   (Browser)   │
                                         └───────┬───────┘
                                                 │
                               ┌─────────────────┼─────────────────┐
                               │                 │                 │
                               ▼                 ▼                 ▼
                    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
                    │   CAR BUYER      │ │ CAR SELLER   │ │    DEALER        │
                    │   Journey        │ │   Journey    │ │    Journey       │
                    └────────┬─────────┘ └──────┬───────┘ └────────┬─────────┘
                             │                  │                  │
                             ▼                  ▼                  ▼
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │                              NEXT.JS FRONTEND (VERCEL)                              │
    │  ┌──────────────────────────────────────────────────────────────────────────────┐  │
    │  │                              REACT COMPONENTS                                 │  │
    │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │  │
    │  │  │  Home   │ │ Catalog │ │ Details │ │ Add     │ │ Chatbot │ │ Profile │   │  │
    │  │  │  Page   │ │  View   │ │  View   │ │ Listing │ │  View   │ │  View   │   │  │
    │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │  │
    │  └──────────────────────────────────────────────────────────────────────────────┘  │
    │  ┌──────────────────────────────────────────────────────────────────────────────┐  │
    │  │                              STATE MANAGEMENT                                 │  │
    │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │  │
    │  │  │   AuthContext   │  │  LocalStorage   │  │  API Client     │              │  │
    │  │  │   (User State)  │  │  (Preferences)  │  │  (Fetch Layer)  │              │  │
    │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘              │  │
    │  └──────────────────────────────────────────────────────────────────────────────┘  │
    └────────────────────────────────────────────┬───────────────────────────────────────┘
                                                 │
                                                 │ REST API (HTTPS)
                                                 │ Authorization: Bearer <token>
                                                 ▼
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │                              FLASK BACKEND (RENDER)                                 │
    │  ┌──────────────────────────────────────────────────────────────────────────────┐  │
    │  │                              API ROUTES                                       │  │
    │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │  │
    │  │  │  /auth  │ │  /cars  │ │  /ai    │ │/dealers │ │/reviews │ │/system  │   │  │
    │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │  │
    │  │       │           │           │           │           │           │         │  │
    │  │       └───────────┴───────────┴───────────┴───────────┴───────────┘         │  │
    │  │                                    │                                         │  │
    │  │                                    ▼                                         │  │
    │  │  ┌──────────────────────────────────────────────────────────────────────┐   │  │
    │  │  │                         SERVICE LAYER                                 │   │  │
    │  │  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │   │  │
    │  │  │   │   AI Service    │    │  Auth Service   │    │  DB Service     │  │   │  │
    │  │  │   │ (Gemini Client) │    │  (Token Mgmt)   │    │  (Query Layer)  │  │   │  │
    │  │  │   └─────────────────┘    └─────────────────┘    └─────────────────┘  │   │  │
    │  │  └──────────────────────────────────────────────────────────────────────┘   │  │
    │  └──────────────────────────────────────────────────────────────────────────────┘  │
    └──────────────────┬─────────────────────────────────┬────────────────────────────────┘
                       │                                 │
           ┌───────────┼───────────┐                     │
           │           │           │                     │
           ▼           ▼           ▼                     ▼
    ┌────────────┐ ┌────────────┐ ┌────────────┐  ┌────────────────┐
    │ PostgreSQL │ │ Cloudinary │ │Google Cloud│  │     SMTP       │
    │  Database  │ │   (CDN)    │ │  (Gemini)  │  │  (Email)       │
    │            │ │            │ │            │  │                │
    │ • users    │ │ • images   │ │ • chatbot  │  │ • notifications│
    │ • cars     │ │ • videos   │ │ • vision   │  │ • password     │
    │ • dealers  │ │ • transform│ │ • embeddings│ │   reset        │
    │ • reviews  │ │            │ │            │  │                │
    │ • favorites│ │            │ │            │  │                │
    └────────────┘ └────────────┘ └────────────┘  └────────────────┘
```

---

## 2. User Authentication Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              USER AUTHENTICATION FLOWS                                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    SIGNUP FLOW
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Database
   │                           │                            │                           │
   │  Enter credentials        │                            │                           │
   │  (username, email, pass)  │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  Validate client-side      │                           │
   │                           │  POST /api/auth/signup     │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Rate limit check (5/min) │
   │                           │                            ├─────────────────────────  │
   │                           │                            │                           │
   │                           │                            │  Validate:                │
   │                           │                            │  • username (3-30 chars)  │
   │                           │                            │  • email (valid format)   │
   │                           │                            │  • password (8+ chars)    │
   │                           │                            │                           │
   │                           │                            │  Hash password            │
   │                           │                            │  (PBKDF2:SHA256:260000)   │
   │                           │                            │                           │
   │                           │                            │  INSERT INTO users        │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │                            │  Generate session token   │
   │                           │                            │  (32-byte secure random)  │
   │                           │                            │                           │
   │                           │                            │  INSERT INTO user_sessions│
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │  { token, user }           │                           │
   │                           │◄───────────────────────────┤                           │
   │  Store token in           │                            │                           │
   │  localStorage             │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                    LOGIN FLOW
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Database
   │                           │                            │                           │
   │  Enter username/password  │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  POST /api/auth/login      │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Rate limit (10/min)      │
   │                           │                            │                           │
   │                           │                            │  SELECT user by username  │
   │                           │                            │  or email                 │
   │                           │                            ├──────────────────────────►│
   │                           │                            │◄──────────────────────────┤
   │                           │                            │                           │
   │                           │                            │  Verify password hash     │
   │                           │                            │  (werkzeug check_password)│
   │                           │                            │                           │
   │                           │                            │  Create new session       │
   │                           │                            │  (7-day expiry)           │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │  { token, user }           │                           │
   │                           │◄───────────────────────────┤                           │
   │  Update AuthContext       │                            │                           │
   │  Redirect to dashboard    │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                 GOOGLE OAUTH FLOW
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Google
   │                           │                            │                           │
   │  Click "Sign in with      │                            │                           │
   │  Google"                  │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  Open Google OAuth popup   │                           │
   │                           ├────────────────────────────┼──────────────────────────►│
   │                           │                            │                           │
   │  User authenticates       │                            │                           │
   │  with Google              │                            │                           │
   │◄────────────────────────────────────────────────────────────────────────────────────┤
   │                           │                            │                           │
   │                           │  Receive ID token          │                           │
   │                           │◄───────────────────────────────────────────────────────┤
   │                           │                            │                           │
   │                           │  POST /api/auth/google     │                           │
   │                           │  { id_token }              │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Verify ID token          │
   │                           │                            │  with Google              │
   │                           │                            ├──────────────────────────►│
   │                           │                            │◄──────────────────────────┤
   │                           │                            │                           │
   │                           │                            │  Find/create user         │
   │                           │                            │  Create session           │
   │                           │                            │                           │
   │                           │  { token, user }           │                           │
   │                           │◄───────────────────────────┤                           │
   │  Logged in!               │                            │                           │
   │◄──────────────────────────┤                            │                           │
```

---

## 3. AI Chatbot Conversation Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              AI CHATBOT CONVERSATION FLOW                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  User                      Frontend                     Backend                    Gemini AI
   │                           │                            │                           │
   │  Type: "Find me a         │                            │                           │
   │  reliable family SUV      │                            │                           │
   │  under 20k JOD"           │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  Show "Thinking..." state  │                           │
   │                           │                            │                           │
   │                           │  POST /api/chatbot         │                           │
   │                           │  {                         │                           │
   │                           │    query: "...",           │                           │
   │                           │    history: [...],         │                           │
   │                           │    image_base64: null      │                           │
   │                           │  }                         │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │                           │
   │                           │                            │  Sanitize input           │
   │                           │                            │  Detect language (AR/EN)  │
   │                           │                            │                           │
   │                           │                            │  Build prompt:            │
   │                           │                            │  ┌─────────────────────┐  │
   │                           │                            │  │ System: You are     │  │
   │                           │                            │  │ IntelliWheels AI... │  │
   │                           │                            │  │                     │  │
   │                           │                            │  │ History: [...]      │  │
   │                           │                            │  │                     │  │
   │                           │                            │  │ User: Find me a...  │  │
   │                           │                            │  └─────────────────────┘  │
   │                           │                            │                           │
   │                           │                            │  Send to Gemini 2.5       │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │                            │                           │
   │                           │                            │    ┌─────────────────────┐│
   │                           │                            │    │ Gemini processes:   ││
   │                           │                            │    │ • Understands query ││
   │                           │                            │    │ • Context: Jordan   ││
   │                           │                            │    │ • Price: JOD        ││
   │                           │                            │    │ • SUV category      ││
   │                           │                            │    │ • Budget: <20k      ││
   │                           │                            │    └─────────────────────┘│
   │                           │                            │                           │
   │                           │                            │  Response with            │
   │                           │                            │  recommendations          │
   │                           │                            │◄──────────────────────────┤
   │                           │                            │                           │
   │                           │                            │  Check for listing intent │
   │                           │                            │  (```json_listing block)  │
   │                           │                            │                           │
   │                           │  {                         │                           │
   │                           │    success: true,          │                           │
   │                           │    response: "Based on...",│                           │
   │                           │    listing_data: null      │                           │
   │                           │  }                         │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  Display AI response      │                            │                           │
   │  with recommendations     │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                              IMAGE + TEXT CONVERSATION
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Gemini AI
   │                           │                            │                           │
   │  Upload car photo +       │                            │                           │
   │  "I want to sell this"    │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  Convert image to base64   │                           │
   │                           │                            │                           │
   │                           │  POST /api/chatbot         │                           │
   │                           │  {                         │                           │
   │                           │    query: "I want to...",  │                           │
   │                           │    image_base64: "data:...",│                          │
   │                           │    history: [...]          │                           │
   │                           │  }                         │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │                           │
   │                           │                            │  Decode base64 image      │
   │                           │                            │  Build multimodal prompt  │
   │                           │                            │                           │
   │                           │                            │  Send to Gemini Vision    │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │                            │    ┌─────────────────────┐│
   │                           │                            │    │ Gemini Vision:      ││
   │                           │                            │    │ • Analyzes image    ││
   │                           │                            │    │ • Detects Toyota    ││
   │                           │                            │    │ • Model: Camry      ││
   │                           │                            │    │ • Year: ~2020       ││
   │                           │                            │    │ • Condition: Good   ││
   │                           │                            │    │ • Price: 14k JOD    ││
   │                           │                            │    └─────────────────────┘│
   │                           │                            │                           │
   │                           │                            │  Response with            │
   │                           │                            │  ```json_listing block    │
   │                           │                            │◄──────────────────────────┤
   │                           │                            │                           │
   │                           │                            │  Parse listing_data       │
   │                           │                            │                           │
   │                           │  {                         │                           │
   │                           │    response: "I can see...",│                          │
   │                           │    listing_data: {         │                           │
   │                           │      make: "Toyota",       │                           │
   │                           │      model: "Camry",       │                           │
   │                           │      year: 2020,           │                           │
   │                           │      price: 14000,         │                           │
   │                           │      currency: "JOD"       │                           │
   │                           │    },                      │                           │
   │                           │    action_type: "create_listing"                       │
   │                           │  }                         │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  Show AI response         │                            │                           │
   │  + "Create Listing" card  │                            │                           │
   │◄──────────────────────────┤                            │                           │
```

---

## 4. Car Listing Creation Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              CAR LISTING CREATION FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    MANUAL LISTING
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                 Cloudinary
   │                           │                            │                           │
   │  Navigate to              │                            │                           │
   │  "Add Listing"            │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │                            │                           │
   │◄──────────────────────────┤                            │                           │
   │  Show listing form        │                            │                           │
   │                           │                            │                           │
   │  Fill in details:         │                            │                           │
   │  • Select Make            │                            │                           │
   │  • Select Model           │  Fetch models for make     │                           │
   │    ─────────────────────►│  GET /api/models?make=X    │                           │
   │                           ├───────────────────────────►│                           │
   │                           │◄───────────────────────────┤                           │
   │◄──────────────────────────┤                            │                           │
   │                           │                            │                           │
   │  • Enter Year             │                            │                           │
   │  • Enter Price            │                            │                           │
   │                           │                            │                           │
   │  Click "AI Price Assist"  │                            │                           │
   │    ─────────────────────►│  POST /api/price-estimate  │                           │
   │                           │  { make, model, year }     │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Calculate estimate       │
   │                           │  { estimate: 15000,        │  (ML model)               │
   │                           │    range: {low, high} }    │                           │
   │                           │◄───────────────────────────┤                           │
   │  Show suggested price     │                            │                           │
   │◄──────────────────────────┤                            │                           │
   │                           │                            │                           │
   │  Upload main photo        │                            │                           │
   │    ─────────────────────►│  POST /api/listings/upload │                           │
   │                           │  (multipart/form-data)     │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Upload to Cloudinary     │
   │                           │                            ├──────────────────────────►│
   │                           │                            │◄──────────────────────────┤
   │                           │                            │  { cloudinary_url }       │
   │                           │◄───────────────────────────┤                           │
   │  Show preview             │                            │                           │
   │◄──────────────────────────┤                            │                           │
   │                           │                            │                           │
   │  Upload gallery (1-6)     │                            │                           │
   │    ─────────────────────►│  (repeat upload process)   │                           │
   │                           │                            │                           │
   │                           │                            │                           │
   │  Click "Publish"          │                            │                           │
   │    ─────────────────────►│  POST /api/cars            │                           │
   │                           │  {                         │                           │
   │                           │    make: "Toyota",         │                           │
   │                           │    model: "Camry",         │                           │
   │                           │    year: 2020,             │                           │
   │                           │    price: 15000,           │                           │
   │                           │    image: "https://...",   │                           │
   │                           │    galleryImages: [...],   │                           │
   │                           │    description: "...",     │                           │
   │                           │    specs: {...}            │                           │
   │                           │  }                         │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Validate & sanitize      │
   │                           │                            │  INSERT INTO cars         │
   │                           │                            │                           │
   │                           │  { success: true,          │                           │
   │                           │    car: { id: 123, ... } } │                           │
   │                           │◄───────────────────────────┤                           │
   │  Success! Redirect to     │                            │                           │
   │  listing detail page      │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                VISION-ASSISTED LISTING
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Gemini
   │                           │                            │                           │
   │  Click "Vision Helper"    │                            │                           │
   │  on Add Listing page      │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │                            │                           │
   │  Upload/drop car photo    │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  Convert to base64         │                           │
   │                           │  POST /api/vision-helper   │                           │
   │                           │  { image_base64: "..." }   │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Send to Gemini Vision    │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │                            │    ┌─────────────────────┐│
   │                           │                            │    │ Analyze image:      ││
   │                           │                            │    │ • Make: BMW         ││
   │                           │                            │    │ • Model: X5         ││
   │                           │                            │    │ • Year: 2021        ││
   │                           │                            │    │ • Body: SUV         ││
   │                           │                            │    │ • Condition: Good   ││
   │                           │                            │    │ • Est: 45,000 JOD   ││
   │                           │                            │    └─────────────────────┘│
   │                           │                            │                           │
   │                           │                            │◄──────────────────────────┤
   │                           │                            │                           │
   │                           │  { attributes: {           │                           │
   │                           │      make: "BMW",          │                           │
   │                           │      model: "X5",          │                           │
   │                           │      year: 2021,           │                           │
   │                           │      bodyStyle: "SUV",     │                           │
   │                           │      estimatedPrice: 45000,│                           │
   │                           │      highlights: [...]     │                           │
   │                           │  }}                        │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  AUTO-FILL FORM:          │                            │                           │
   │  ┌─────────────────────┐  │                            │                           │
   │  │ Make: [BMW     ▼]   │  │                            │                           │
   │  │ Model: [X5     ▼]   │  │                            │                           │
   │  │ Year: [2021      ]  │  │                            │                           │
   │  │ Price: [45,000   ]  │  │                            │                           │
   │  │ Body: [SUV     ▼]   │  │                            │                           │
   │  └─────────────────────┘  │                            │                           │
   │                           │                            │                           │
   │◄──────────────────────────┤                            │                           │
   │                           │                            │                           │
   │  Review & adjust values   │                            │                           │
   │  Click "Publish"          │                            │                           │
   │    ─────────────────────►│  (same as manual flow)     │                           │
```

---

## 5. Semantic Search Algorithm

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SEMANTIC SEARCH ALGORITHM                                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

INPUT: User query "luxury SUV under 50k with good fuel economy"

═══════════════════════════════════════════════════════════════════════════════════════════
                                    STEP 1: PARSE QUERY
═══════════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  Query: "luxury SUV under 50k with good fuel economy"                                   │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  PRICE EXTRACTION                                                                   │ │
│  │  Pattern: /(?:under|below|less than|max|<)\s*(\d+)\s*k?/                           │ │
│  │  Match: "under 50k"  →  max_price = 50,000 JOD                                     │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  KEYWORD EXTRACTION                                                                 │ │
│  │  Remove: price phrases, stop words (the, a, with, for, etc.)                       │ │
│  │  Result: ["luxury", "suv", "good", "fuel", "economy"]                              │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    STEP 2: CATEGORY MAPPING
═══════════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  LUXURY MAKES = {mercedes, bmw, audi, lexus, porsche, bentley, rolls-royce,            │
│                  maserati, jaguar, land rover, range rover, infiniti, cadillac}         │
│                                                                                          │
│  BODY KEYWORDS = {                                                                       │
│    'suv': ['suv', 'crossover', '4x4'],                                                  │
│    'sedan': ['sedan', 'saloon'],                                                         │
│    'coupe': ['coupe', 'sports'],                                                         │
│    ...                                                                                   │
│  }                                                                                       │
│                                                                                          │
│  FUEL KEYWORDS = {                                                                       │
│    'hybrid': ['hybrid', 'fuel economy', 'efficient'],                                   │
│    'electric': ['electric', 'ev', 'battery'],                                           │
│    ...                                                                                   │
│  }                                                                                       │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    STEP 3: SCORE EACH CAR
═══════════════════════════════════════════════════════════════════════════════════════════

For each car in database:

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  Car: BMW X5 2021, Price: 45,000 JOD, Specs: {bodyStyle: "SUV", fuelType: "hybrid"}    │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  SCORING BREAKDOWN:                                                                 │ │
│  │                                                                                      │ │
│  │  Keyword: "luxury"                                                                  │ │
│  │    → BMW in LUXURY_MAKES                          +40 points                        │ │
│  │                                                                                      │ │
│  │  Keyword: "suv"                                                                     │ │
│  │    → "SUV" in specs.bodyStyle                     +20 points                        │ │
│  │                                                                                      │ │
│  │  Keyword: "fuel"                                                                    │ │
│  │    → "hybrid" in specs.fuelType                   +20 points                        │ │
│  │                                                                                      │ │
│  │  Price check: 45,000 ≤ 50,000 (max_price)                                           │ │
│  │    → Bonus: 15 × (45000/50000) = 13.5             +13.5 points                      │ │
│  │                                                                                      │ │
│  │  ─────────────────────────────────────────────────────────────                      │ │
│  │  TOTAL SCORE:                                      93.5 points                      │ │
│  │                                                                                      │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│  Car: Toyota Camry 2020, Price: 15,000 JOD, Specs: {bodyStyle: "Sedan"}                │
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  SCORING BREAKDOWN:                                                                 │ │
│  │                                                                                      │ │
│  │  Keyword: "luxury"                                                                  │ │
│  │    → Toyota NOT in LUXURY_MAKES                   +0 points                         │ │
│  │                                                                                      │ │
│  │  Keyword: "suv"                                                                     │ │
│  │    → "Sedan" ≠ "SUV"                              +0 points                         │ │
│  │                                                                                      │ │
│  │  Price check: 15,000 ≤ 50,000                                                       │ │
│  │    → Bonus: 15 × (15000/50000) = 4.5              +4.5 points                       │ │
│  │                                                                                      │ │
│  │  ─────────────────────────────────────────────────────────────                      │ │
│  │  TOTAL SCORE:                                      4.5 points                       │ │
│  │                                                                                      │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    STEP 4: RANK & RETURN
═══════════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  SORTED RESULTS (by score descending):                                                  │
│                                                                                          │
│  ┌────┬─────────────────────────────────────┬───────────┬────────────┐                 │
│  │ #  │ Car                                 │ Score     │ Similarity │                 │
│  ├────┼─────────────────────────────────────┼───────────┼────────────┤                 │
│  │ 1  │ BMW X5 2021 - 45,000 JOD           │ 93.5      │ 1.00       │                 │
│  │ 2  │ Mercedes GLE 2020 - 48,000 JOD     │ 88.0      │ 0.94       │                 │
│  │ 3  │ Lexus RX 2022 - 42,000 JOD         │ 82.5      │ 0.88       │                 │
│  │ 4  │ Audi Q5 2019 - 38,000 JOD          │ 76.0      │ 0.81       │                 │
│  │ 5  │ Range Rover Evoque - 49,000 JOD    │ 71.5      │ 0.76       │                 │
│  │ 6  │ Porsche Cayenne 2018 - 47,000 JOD  │ 68.0      │ 0.73       │                 │
│  └────┴─────────────────────────────────────┴───────────┴────────────┘                 │
│                                                                                          │
│  Return top 6 (or limit) results                                                        │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Review & Rating System

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              REVIEW & RATING SYSTEM                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    ADD REVIEW FLOW
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                    Database
   │                           │                            │                           │
   │  View car detail page     │                            │                           │
   │  for BMW X5 (id: 123)     │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  GET /api/reviews/car/123  │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  SELECT reviews           │
   │                           │                            │  JOIN users               │
   │                           │                            │  WHERE car_id = 123       │
   │                           │                            ├──────────────────────────►│
   │                           │                            │◄──────────────────────────┤
   │                           │  { reviews: [...],         │                           │
   │                           │    stats: {avg: 4.5,       │                           │
   │                           │            count: 12} }    │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  Show existing reviews:   │                            │                           │
   │  ┌─────────────────────┐  │                            │                           │
   │  │ ⭐⭐⭐⭐⭐ 4.5 (12)  │  │                            │                           │
   │  │                     │  │                            │                           │
   │  │ Ahmad K. ⭐⭐⭐⭐⭐  │  │                            │                           │
   │  │ "Great car, smooth" │  │                            │                           │
   │  │                     │  │                            │                           │
   │  │ Sara M. ⭐⭐⭐⭐☆   │  │                            │                           │
   │  │ "Good but pricey"   │  │                            │                           │
   │  └─────────────────────┘  │                            │                           │
   │◄──────────────────────────┤                            │                           │
   │                           │                            │                           │
   │  Click "Add Review"       │                            │                           │
   │  Rate: ⭐⭐⭐⭐⭐ (5)     │                            │                           │
   │  Comment: "Excellent!"    │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │  POST /api/reviews/car/123 │                           │
   │                           │  { rating: 5,              │                           │
   │                           │    comment: "Excellent!" } │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │  Check authentication     │
   │                           │                            │  Validate rating (1-5)    │
   │                           │                            │  Sanitize comment         │
   │                           │                            │                           │
   │                           │                            │  INSERT INTO reviews      │
   │                           │                            │  (car_id, user_id,        │
   │                           │                            │   rating, comment)        │
   │                           │                            │  ON CONFLICT UPDATE       │
   │                           │                            │  (one review per user)    │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │  { success: true,          │                           │
   │                           │    review: {...} }         │                           │
   │                           │◄───────────────────────────┤                           │
   │  Show updated reviews     │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                 REVIEW DATA MODEL
═══════════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              reviews TABLE                                        │   │
│  ├──────────────────────────────────────────────────────────────────────────────────┤   │
│  │  id            │ INTEGER PRIMARY KEY                                             │   │
│  │  car_id        │ INTEGER REFERENCES cars(id) ON DELETE CASCADE                   │   │
│  │  user_id       │ INTEGER REFERENCES users(id) ON DELETE CASCADE                  │   │
│  │  rating        │ INTEGER CHECK(rating >= 1 AND rating <= 5)                      │   │
│  │  comment       │ TEXT                                                            │   │
│  │  created_at    │ TIMESTAMP DEFAULT CURRENT_TIMESTAMP                             │   │
│  │  updated_at    │ TIMESTAMP DEFAULT CURRENT_TIMESTAMP                             │   │
│  │                                                                                   │   │
│  │  UNIQUE(car_id, user_id)  -- One review per user per car                         │   │
│  └──────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  Stats Calculation:                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  SELECT AVG(rating) as avg_rating, COUNT(*) as count                               │ │
│  │  FROM reviews                                                                       │ │
│  │  WHERE car_id = ?                                                                   │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Media Upload Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              MEDIA UPLOAD PIPELINE                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    IMAGE UPLOAD
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                 Cloudinary
   │                           │                            │                           │
   │  Select image file        │                            │                           │
   │  (JPEG, PNG, up to 10MB)  │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │                            │                           │
   │                           │  Validate file:            │                           │
   │                           │  • Size ≤ 10MB             │                           │
   │                           │  • Type: image/*           │                           │
   │                           │                            │                           │
   │                           │  Create FormData           │                           │
   │                           │  POST /api/listings/image  │                           │
   │                           │  Content-Type: multipart   │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │                           │
   │                           │                            │  Check Cloudinary config  │
   │                           │                            │                           │
   │                           │                            │  ┌─────────────────────┐  │
   │                           │                            │  │ IF Cloudinary:      │  │
   │                           │                            │  │   Upload to cloud   │──►│
   │                           │                            │  │                     │  │
   │                           │                            │  │ ELSE:               │  │
   │                           │                            │  │   Save locally      │  │
   │                           │                            │  │   /uploads/images/  │  │
   │                           │                            │  └─────────────────────┘  │
   │                           │                            │                           │
   │                           │                            │◄──────────────────────────┤
   │                           │                            │  { secure_url }           │
   │                           │                            │                           │
   │                           │  { success: true,          │                           │
   │                           │    url: "https://res..." } │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  Show preview thumbnail   │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                    VIDEO UPLOAD
═══════════════════════════════════════════════════════════════════════════════════════════

  User                      Frontend                     Backend                 Cloudinary
   │                           │                            │                           │
   │  Select video file        │                            │                           │
   │  (MP4, MOV, up to 500MB)  │                            │                           │
   ├──────────────────────────►│                            │                           │
   │                           │                            │                           │
   │                           │  Show upload progress bar  │                           │
   │                           │  POST /api/listings/video  │                           │
   │                           ├───────────────────────────►│                           │
   │                           │                            │                           │
   │                           │                            │  Stream to Cloudinary     │
   │                           │                            │  resource_type: "video"   │
   │                           │                            ├──────────────────────────►│
   │                           │                            │                           │
   │                           │                            │    ┌─────────────────────┐│
   │                           │                            │    │ Cloudinary:         ││
   │                           │                            │    │ • Transcoding       ││
   │                           │                            │    │ • Generate poster   ││
   │                           │                            │    │ • Adaptive stream   ││
   │                           │                            │    └─────────────────────┘│
   │                           │                            │                           │
   │                           │                            │◄──────────────────────────┤
   │                           │  { url, poster_url }       │                           │
   │                           │◄───────────────────────────┤                           │
   │                           │                            │                           │
   │  Show video player        │                            │                           │
   │◄──────────────────────────┤                            │                           │


═══════════════════════════════════════════════════════════════════════════════════════════
                                 STORAGE COMPARISON
═══════════════════════════════════════════════════════════════════════════════════════════

┌───────────────────────────────────────┬───────────────────────────────────────┐
│          LOCAL STORAGE                │          CLOUDINARY (CDN)             │
│          (Development)                │          (Production)                 │
├───────────────────────────────────────┼───────────────────────────────────────┤
│                                       │                                       │
│  /backend/uploads/                    │  https://res.cloudinary.com/          │
│    ├── images/                        │    └── intelliwheels/                 │
│    │     ├── car_1_main.jpg          │          ├── image/upload/            │
│    │     ├── car_1_gallery_1.jpg     │          │     └── v123/car_1.jpg     │
│    │     └── ...                     │          └── video/upload/            │
│    └── videos/                        │                └── v456/car_1.mp4    │
│          └── car_1_video.mp4         │                                       │
│                                       │                                       │
│  ⚠️ EPHEMERAL                         │  ✅ PERSISTENT                        │
│  Files lost on redeploy              │  Global CDN delivery                  │
│                                       │  Auto-optimization                    │
│  Good for: Local development         │  Good for: Production                 │
│                                       │                                       │
└───────────────────────────────────────┴───────────────────────────────────────┘
```

---

## 8. Analytics Dashboard Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ANALYTICS DATA FLOW                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    MY LISTINGS ANALYTICS
═══════════════════════════════════════════════════════════════════════════════════════════

  Dealer User                   Frontend                     Backend
       │                           │                            │
       │  View "Analytics" tab     │                            │
       │  in Dealer Hub            │                            │
       ├──────────────────────────►│                            │
       │                           │  GET /api/my-listings/     │
       │                           │      analytics             │
       │                           │  Auth: Bearer <token>      │
       │                           ├───────────────────────────►│
       │                           │                            │
       │                           │                            │  Query user's listings
       │                           │                            │  
       │                           │                            │  ┌─────────────────────┐
       │                           │                            │  │ SELECT:             │
       │                           │                            │  │ • COUNT(*) total    │
       │                           │                            │  │ • SUM(price) value  │
       │                           │                            │  │ • AVG(price)        │
       │                           │                            │  │ • MIN/MAX price     │
       │                           │                            │  │ • GROUP BY make     │
       │                           │                            │  │ • GROUP BY year     │
       │                           │                            │  │ • GROUP BY body     │
       │                           │                            │  │ • ORDER BY created  │
       │                           │                            │  └─────────────────────┘
       │                           │                            │
       │                           │  {                         │
       │                           │    total_listings: 23,     │
       │                           │    total_value: 575000,    │
       │                           │    average_price: 25000,   │
       │                           │    price_range: {          │
       │                           │      min: 8000,            │
       │                           │      max: 65000            │
       │                           │    },                      │
       │                           │    listings_by_make: [     │
       │                           │      {make: "Toyota", 8},  │
       │                           │      {make: "BMW", 5},     │
       │                           │      ...                   │
       │                           │    ],                      │
       │                           │    recent_listings: [...]  │
       │                           │  }                         │
       │                           │◄───────────────────────────┤
       │                           │                            │
       │  Display Dashboard:       │                            │
       │  ┌─────────────────────────────────────────────────┐  │
       │  │  📊 MY LISTINGS ANALYTICS                       │  │
       │  │                                                 │  │
       │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────┐ │  │
       │  │  │  Total  │ │  Value  │ │   Avg   │ │ Range │ │  │
       │  │  │   23    │ │ 575,000 │ │ 25,000  │ │ 8k-65k│ │  │
       │  │  │listings │ │   JOD   │ │   JOD   │ │  JOD  │ │  │
       │  │  └─────────┘ └─────────┘ └─────────┘ └───────┘ │  │
       │  │                                                 │  │
       │  │  📈 LISTINGS BY MAKE                           │  │
       │  │  Toyota  ████████████████████  8               │  │
       │  │  BMW     ████████████  5                       │  │
       │  │  Honda   ████████  4                           │  │
       │  │  Mercedes ██████  3                            │  │
       │  │                                                 │  │
       │  └─────────────────────────────────────────────────┘  │
       │◄──────────────────────────────────────────────────────┤


═══════════════════════════════════════════════════════════════════════════════════════════
                                    MARKET INSIGHTS
═══════════════════════════════════════════════════════════════════════════════════════════

       │                           │                            │
       │  View "Market Insights"   │                            │
       │  tab                      │                            │
       ├──────────────────────────►│                            │
       │                           │  GET /api/analytics/       │
       │                           │      insights              │
       │                           ├───────────────────────────►│
       │                           │                            │
       │                           │                            │  Aggregate all listings
       │                           │                            │  
       │                           │  {                         │
       │                           │    summary: {              │
       │                           │      average_price: 25000, │
       │                           │      total_listings: 42    │
       │                           │    },                      │
       │                           │    market_top_makes: [     │
       │                           │      {Toyota, 22k, 15},    │
       │                           │      {BMW, 45k, 8},        │
       │                           │      ...                   │
       │                           │    ],                      │
       │                           │    price_distribution: [   │
       │                           │      {"<10k": 5},          │
       │                           │      {"10-30k": 20},       │
       │                           │      {"30-60k": 10},       │
       │                           │      {">60k": 7}           │
       │                           │    ],                      │
       │                           │    growth_trends: [...]    │
       │                           │  }                         │
       │                           │◄───────────────────────────┤
       │                           │                            │
       │  Display Charts:          │                            │
       │  ┌─────────────────────────────────────────────────┐  │
       │  │  🌍 MARKET INSIGHTS                             │  │
       │  │                                                 │  │
       │  │  PRICE DISTRIBUTION         TOP MAKES          │  │
       │  │  ┌───────────────┐     ┌─────────────────┐     │  │
       │  │  │     ▓▓▓      │     │ Toyota   15 avg:22k│   │  │
       │  │  │   ▓▓▓▓▓▓▓    │     │ BMW       8 avg:45k│   │  │
       │  │  │ ▓▓▓▓▓▓▓▓▓▓▓  │     │ Mercedes  6 avg:52k│   │  │
       │  │  │▓▓▓▓▓▓▓▓▓▓▓▓▓▓│     └─────────────────┘     │  │
       │  │  │<10 10-30 30-60 >60│                         │  │
       │  │  └───────────────┘                              │  │
       │  │                                                 │  │
       │  └─────────────────────────────────────────────────┘  │
       │◄──────────────────────────────────────────────────────┤
```

---

## 9. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ERROR HANDLING PATTERNS                                     │
└─────────────────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════════
                                    API ERROR RESPONSES
═══════════════════════════════════════════════════════════════════════════════════════════

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │                           HTTP STATUS CODE MAPPING                                   │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                      │
  │  200 OK              │  Request successful                                          │
  │  201 Created         │  Resource created (signup, new listing)                      │
  │  400 Bad Request     │  Validation error (missing/invalid fields)                   │
  │  401 Unauthorized    │  Authentication required or token invalid                    │
  │  403 Forbidden       │  Admin access required                                       │
  │  404 Not Found       │  Resource doesn't exist                                      │
  │  409 Conflict        │  Duplicate entry (email/username exists)                     │
  │  429 Too Many Req    │  Rate limit exceeded                                         │
  │  500 Server Error    │  Unexpected backend error                                    │
  │                                                                                      │
  └─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    ERROR RESPONSE FORMAT
═══════════════════════════════════════════════════════════════════════════════════════════

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                      │
  │  SUCCESS RESPONSE:                                                                   │
  │  {                                                                                   │
  │    "success": true,                                                                  │
  │    "data": { ... }                                                                   │
  │  }                                                                                   │
  │                                                                                      │
  │  ERROR RESPONSE:                                                                     │
  │  {                                                                                   │
  │    "success": false,                                                                 │
  │    "error": "Human-readable error message"                                           │
  │  }                                                                                   │
  │                                                                                      │
  └─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    FRONTEND ERROR HANDLING
═══════════════════════════════════════════════════════════════════════════════════════════

  User Action               Frontend                        Display
       │                       │                               │
       │  Submit form          │                               │
       ├──────────────────────►│                               │
       │                       │  API request...               │
       │                       │  ───────────────►            │
       │                       │                               │
       │                       │  ◄─── 400 Bad Request         │
       │                       │  { error: "Price required" }  │
       │                       │                               │
       │                       │  Parse error message          │
       │                       │  ─────────────────────────────►
       │                       │                               │
       │                       │  Show inline error:           │
       │  ┌─────────────────────────────────────────────────┐  │
       │  │  Price: [_____________]                         │  │
       │  │         ⚠️ Price is required                    │  │
       │  └─────────────────────────────────────────────────┘  │
       │◄──────────────────────────────────────────────────────┤
       │                       │                               │
       │                       │  ◄─── 401 Unauthorized        │
       │                       │                               │
       │                       │  Clear auth state             │
       │                       │  Redirect to login            │
       │◄──────────────────────┤                               │
       │                       │                               │
       │                       │  ◄─── 500 Server Error        │
       │                       │                               │
       │                       │  Show toast notification:     │
       │  ┌─────────────────────────────────────────────────┐  │
       │  │  ❌ Something went wrong. Please try again.     │  │
       │  └─────────────────────────────────────────────────┘  │
       │◄──────────────────────────────────────────────────────┤
```

---

*End of Visual Diagrams Document*
